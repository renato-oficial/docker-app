name: Node.js CI

on: 
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: 
      name: development
      url: https://rapidfinance.com.br
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Deploy with SCP
        uses: appleboy/scp-action@v0.1.3
        with:
          host: 149.248.57.32
          username: root
          password: ${{ secrets.SECRET_SSH_PASSWORD }}
          port: 22
          source: "./"
          target: "/home/rapid-finance"
          overwrite: true

      - name: Execute remote command
        uses: appleboy/ssh-action@v0.1.3
        with:
          host: 149.248.57.32
          username: root
          password: ${{ secrets.SECRET_SSH_PASSWORD }}
          port: 22
          script: |
            if ! command -v docker &> /dev/null; then
              echo "⚠️ Instalando Docker..."
              apt-get update
              apt-get install -y ca-certificates curl gnupg lsb-release
              install -m 0755 -d /etc/apt/keyrings
              curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
              chmod a+r /etc/apt/keyrings/docker.gpg
              echo \
                "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
                $(lsb_release -cs) stable" > /etc/apt/sources.list.d/docker.list
                apt-get update
                apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
              echo "✅ Docker instalado!"
            else
               echo "✅ Docker já está instalado."
            fi
          script_stop: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          