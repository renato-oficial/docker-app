name: Node.js CI

on: 
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: 
      name: development
      url: https://rapidfinance.com.br
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Deploy with SCP
        uses: appleboy/scp-action@v0.1.3
        with:
          host: ${{ secrets.SECRET_RAPIDFINANCE_HOST}}
          username: root
          password: ${{ secrets.SECRET_RAPIDFINANCE_PASSWORD }}
          port: 22
          source: "./"
          target: "/home/rapid-finance"
          overwrite: true

      - name: Execute remote command
        uses: appleboy/ssh-action@v0.1.3
        with:
          host: ${{ secrets.SECRET_RAPIDFINANCE_HOST }}
          username: root
          password: ${{ secrets.SECRET_RAPIDFINANCE_PASSWORD }}
          port: 22
          script: |
            set -e

            echo "🔍 Verificando certificado SSL existente..."
            if [ ! -f "/etc/letsencrypt/live/$DOMAIN/fullchain.pem" ]; then
              echo "🔒 Nenhum certificado encontrado. Instalando Certbot e gerando..."
              apt update && apt install -y certbot
              certbot certonly --standalone -d $DOMAIN -d www.$DOMAIN \
                --non-interactive --agree-tos -m $EMAIL
              echo "✅ Certificado emitido!"
            else
              echo "✅ Certificado já existe. Pulando geração."
            fi

            # Instala Docker se necessário
            if ! command -v docker &> /dev/null; then
              echo "⚠️ Instalando Docker..."
              apt-get update
              apt-get install -y ca-certificates curl gnupg lsb-release

              install -m 0755 -d /etc/apt/keyrings
              curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
              chmod a+r /etc/apt/keyrings/docker.gpg

              echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] \
                https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" \
                > /etc/apt/sources.list.d/docker.list

              apt-get update
              apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
              echo "✅ Docker instalado!"
            else
              echo "✅ Docker já está instalado."
            fi

            # Executa o deploy
            sudo ufw allow 80
            cd /home/rapid-finance
            docker compose -f docker-compose.yml down --remove-orphans
            docker compose -f docker-compose.yml up -d --build
            echo "🚀 Deploy finalizado com sucesso!"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          