name: Node.js CI

on: 
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: 
      name: development
      url: https://renatodev.tech/
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Deploy with SCP
        uses: appleboy/scp-action@v0.1.3
        with:
          host: 191.252.181.250
          username: root
          password: ${{ secrets.SECRET_SSH_PASSWORD }}
          port: 22
          source: "./"
          target: "/home/docker-app"
          overwrite: true

      - name: Gerar .env
        run: |
          echo "GITHUB_TOKEN=${GITHUB_TOKEN}" >> .env
          echo "ENDPOINT=${ENDPOINT}" >> .env
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ENDPOINT: ${{ secrets.ENDPOINT }}
          
      - name: Execute remote command
        uses: appleboy/ssh-action@v0.1.3
        with:
          host: 191.252.181.250
          username: root
          password: ${{ secrets.SECRET_SSH_PASSWORD }}
          port: 22
          script: |
            set -e

            echo "ðŸ” Verificando certificado SSL existente..."
            if [ ! -f "/etc/letsencrypt/live/renatodev.tech/fullchain.pem" ]; then
              echo "ðŸ”’ Nenhum certificado encontrado. Instalando Certbot e gerando..."
              apt update && apt install -y certbot
              certbot certonly --standalone -d renatodev.tech -d www.renatodev.tech --non-interactive --agree-tos -m contato@rapidfinance.com.br
              echo "âœ… Certificado emitido!"
            else
              echo "âœ… Certificado jÃ¡ existe. Pulando geraÃ§Ã£o."
            fi

            # Instala Docker se necessÃ¡rio
            if ! command -v docker &> /dev/null; then
              echo "âš ï¸ Instalando Docker..."
              apt-get update
              apt-get install -y ca-certificates curl gnupg lsb-release

              install -m 0755 -d /etc/apt/keyrings
              curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
              chmod a+r /etc/apt/keyrings/docker.gpg

              echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] \
                https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" \
                > /etc/apt/sources.list.d/docker.list

              apt-get update
              apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
              echo "âœ… Docker instalado!"
            else
              echo "âœ… Docker jÃ¡ estÃ¡ instalado."
            fi

            # Executa o deploy
            sudo ufw allow 80
            sudo ufw allow 443
            cd /home/docker-app
            echo "ENDPOINT=${ENDPOINT}" >> .env
            echo "GITHUB_TOKEN=${GITHUB_TOKEN}" >> .env
            docker compose -f docker-compose.yml down --remove-orphans
            docker compose -f docker-compose.yml up -d --build
            echo "ðŸš€ Deploy finalizado com sucesso!"
        
          